# YoForex Hybrid Deployment Guide

## üèóÔ∏è Architecture Overview

YoForex uses a **Smart Hybrid Architecture** with two servers:

1. **Express Server (Port 5000)**
   - Authentication (Replit OIDC)
   - API endpoints for mutations
   - React app (Vite-built frontend)
   - Background jobs (cron)
   - Email notifications

2. **Next.js Server (Port 3000)**
   - SEO-optimized pages with Server-Side Rendering
   - Direct PostgreSQL queries for performance
   - ISR (Incremental Static Regeneration)
   - Pages: Homepage, Discussions, Marketplace, Brokers, etc.

## üöÄ Deployment Steps for Replit

### Step 1: Configure Replit Deployment

1. **Open your Replit workspace**
2. **Click on the "Shell" icon** (top right)
3. **Go to "Tools" ‚Üí "Secrets"** and verify these environment variables:
   - `DATABASE_URL` (should be auto-set by Replit)
   - `BASE_URL` (set to your deployment URL: https://eah-yoforexpremium.replit.app)
   - `BREVO_API_KEY` (if using email)
   - `BREVO_FROM_EMAIL` (if using email)

### Step 2: Update Replit Run Command

**You need to manually update the Run command:**

1. Click **"Configure"** in the top menu
2. Find **"Run command"** setting
3. Change it to: `bash start-hybrid.sh`
4. Save the configuration

### Step 3: Update Deployment Configuration

For **production deployment**:

1. Go to **"Publishing"** or **"Deployments"** tab
2. Update the **"Run command"** for production to:
   ```bash
   bash start-production.sh
   ```

### Step 4: Restart Your Development Server

1. Stop the current workflow (Ctrl+C or click Stop button)
2. Click **"Run"** button - it should now use `start-hybrid.sh`
3. Verify both servers start:
   - Express: `http://localhost:5000`
   - Next.js: `http://localhost:3000`

### Step 5: Test Locally First

Before deploying, test that both servers work:

1. Visit `/discussions` - should show filtering interface
2. Visit `/marketplace` - should show marketplace with filters
3. Visit `/brokers` - should show broker directory with filters
4. Try searching and filtering on each page
5. Check that pagination works correctly

### Step 6: Deploy to Production

1. Click **"Publish"** or **"Deploy"** button
2. Replit will:
   - Build your Vite frontend
   - Build your Next.js pages
   - Start both servers
   - Make them available at your deployment URL

## üîç Verification Checklist

After deployment, verify these URLs work:

- ‚úÖ `https://eah-yoforexpremium.replit.app/` - Homepage
- ‚úÖ `https://eah-yoforexpremium.replit.app/discussions` - Forum with filters
- ‚úÖ `https://eah-yoforexpremium.replit.app/marketplace` - Marketplace with filters
- ‚úÖ `https://eah-yoforexpremium.replit.app/brokers` - Brokers with filters
- ‚úÖ `https://eah-yoforexpremium.replit.app/api/stats` - Express API

## üêõ Troubleshooting

### Issue: "No content found" on Next.js pages

**Cause**: Next.js server is not running
**Solution**: 
1. Verify both servers started in logs
2. Check that `start-hybrid.sh` is being used
3. Ensure port 3000 is not blocked

### Issue: "Address already in use" error

**Cause**: Server already running on port 5000 or 3000
**Solution**:
```bash
# Kill existing processes
pkill -f "tsx server/index.ts"
pkill -f "next dev"
# Then restart
bash start-hybrid.sh
```

### Issue: Database connection errors on Next.js pages

**Cause**: `DATABASE_URL` not available to Next.js
**Solution**:
1. Check environment variables in Replit Secrets
2. Ensure `DATABASE_URL` is set
3. Restart both servers

## üìä Port Configuration

| Server | Port | Purpose | URL |
|--------|------|---------|-----|
| Express | 5000 | Auth, API, React app | Main deployment URL |
| Next.js | 3000 | SEO pages | Internal (proxied) |

## üîê Environment Variables Required

Required for production:
- `DATABASE_URL` - PostgreSQL connection (auto-set by Replit)
- `BASE_URL` - Your deployment URL
- `SESSION_SECRET` - Auto-generated by Express

Optional:
- `BREVO_API_KEY` - Email notifications
- `BREVO_FROM_EMAIL` - Sender email
- `STRIPE_SECRET_KEY` - Payment processing

## üìù Important Notes

1. **Both servers must run** for full functionality
2. **Express (5000)** serves the React app at the root URL
3. **Next.js (3000)** handles SEO-critical pages directly
4. **Database is shared** between both servers
5. **Sessions work** across both (shared PostgreSQL store)

## üéØ Production Checklist

Before going live:

- [ ] Both servers start successfully
- [ ] All 16 Next.js pages accessible
- [ ] Filtering works on discussions/marketplace/brokers
- [ ] Database connection stable
- [ ] Background jobs running
- [ ] Environment variables set
- [ ] SSL/HTTPS working (Replit handles this)
- [ ] Custom domain configured (optional)

## üöÄ Performance Tips

1. **Enable ISR**: Next.js pages revalidate every 60 seconds
2. **Database indexes**: Already configured for key queries
3. **CDN**: Replit provides edge caching automatically
4. **Monitoring**: Check Replit deployment logs regularly

## üìû Support

If you encounter issues:
1. Check deployment logs in Replit
2. Verify both servers are running
3. Test database connection
4. Check environment variables

---

**Your hybrid deployment is production-ready!** üéâ
